{% extends 'base.html' %}

{% block title %}Buat Pertemuan - {{ eskul.nama_eskul }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-success">
                <i class="bi bi-journal-plus me-2"></i>Buat Pertemuan Baru
            </h2>
            <a href="{% url 'pelatih_history_pertemuan' %}" class="btn btn-secondary">
                <i class="bi bi-clock-history me-2"></i>Riwayat
            </a>
        </div>
    </div>
</div>

<!-- Eskul Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">
                        <i class="bi bi-collection me-2"></i>{{ eskul.nama_eskul }}
                    </h5>
                    <p class="mb-0">
                        <i class="bi bi-people me-1"></i>{{ siswa_list|length }} siswa terdaftar
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-primary fs-6">{{ today|date:"l, d F Y" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Warning -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Perhatian:</strong> Data pertemuan yang sudah disimpan tidak dapat diubah lagi. 
            Pastikan semua informasi sudah benar sebelum menyimpan.
        </div>
    </div>
</div>

<!-- Main Form -->
<form method="post" enctype="multipart/form-data" id="pertemuanForm">
    {% csrf_token %}
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Basic Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Informasi Pertemuan
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="tanggal" class="form-label">
                            <i class="bi bi-calendar me-1"></i>Tanggal Pertemuan <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control form-control-lg" 
                               id="tanggal" name="tanggal" value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="materi_kegiatan" class="form-label">
                            <i class="bi bi-journal-text me-1"></i>Materi Kegiatan <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="materi_kegiatan" name="materi_kegiatan" 
                                rows="4" required 
                                placeholder="Contoh: Latihan gerakan tari Saman, belajar koordinasi gerakan tangan dan kepala..."></textarea>
                        <div class="form-text">Jelaskan kegiatan yang dilakukan pada pertemuan ini</div>
                    </div>
                </div>
            </div>

            <!-- Photo Upload Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-camera me-2"></i>Dokumentasi Kegiatan
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="foto_kegiatan" class="form-label">
                            <i class="bi bi-images me-1"></i>Upload Foto Kegiatan
                        </label>
                        <input type="file" class="form-control" id="foto_kegiatan" 
                               name="foto_kegiatan" multiple accept="image/*" capture="camera">
                        <div class="form-text">
                            Bisa upload beberapa foto sekaligus. Klik "capture" untuk langsung foto dari kamera.
                        </div>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div id="photoPreview" class="row g-2 mt-2" style="display: none;">
                        <div class="col-12">
                            <small class="text-muted">Preview Foto:</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Attendance -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-check me-2"></i>Absensi Siswa ({{ siswa_list|length }})
                </div>
                <div class="card-body">
                    {% if siswa_list %}
                        <div class="mb-3">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-success" onclick="setAllAttendance('hadir')">
                                    <i class="bi bi-check-all me-1"></i>Semua Hadir
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetAttendance()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for siswa in siswa_list %}
                                    <tr>
                                        <td>
                                            <strong>{{ siswa.nama_siswa }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ siswa.kelas }}</span>
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm attendance-select" 
                                                    name="absensi_{{ siswa.id }}" onchange="updateAttendanceColor(this)">
                                                <option value="alpha">‚ùå Alpha</option>
                                                <option value="hadir">‚úÖ Hadir</option>
                                                <option value="sakit">üè• Sakit</option>
                                                <option value="izin">üìù Izin</option>
                                            </select>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Attendance Summary -->
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="hadirCount">0</div>
                                            <small>Hadir</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="sakitCount">0</div>
                                            <small>Sakit</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="izinCount">0</div>
                                            <small>Izin</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="alphaCount">{{ siswa_list|length }}</div>
                                            <small>Alpha</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted">Tidak ada siswa terdaftar di eskul ini.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-success btn-lg px-5" onclick="confirmSubmit()">
                        <i class="bi bi-save me-2"></i>Simpan Pertemuan
                    </button>
                    <p class="text-muted mt-2 mb-0">
                        <small><i class="bi bi-info-circle me-1"></i>Data tidak dapat diubah setelah disimpan</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Photo preview functionality
document.getElementById('foto_kegiatan').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = '<div class="col-12"><small class="text-muted">Preview Foto:</small></div>';
    
    if (files.length > 0) {
        files.forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'col-4 col-md-3';
                    div.innerHTML = `
                        <div class="position-relative">
                            <img src="${e.target.result}" class="img-fluid rounded shadow-sm" 
                                 style="height: 80px; object-fit: cover; width: 100%;">
                            <span class="position-absolute top-0 start-0 badge bg-primary">${index + 1}</span>
                        </div>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            }
        });
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

// Attendance functions
function setAllAttendance(status) {
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.value = status;
        updateAttendanceColor(select);
    });
    updateAttendanceCount();
}

function resetAttendance() {
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.value = 'alpha';
        updateAttendanceColor(select);
    });
    updateAttendanceCount();
}

function updateAttendanceColor(select) {
    select.className = 'form-select form-select-sm attendance-select';
    switch(select.value) {
        case 'hadir':
            select.classList.add('text-success', 'fw-bold');
            break;
        case 'sakit':
            select.classList.add('text-warning', 'fw-bold');
            break;
        case 'izin':
            select.classList.add('text-info', 'fw-bold');
            break;
        case 'alpha':
            select.classList.add('text-danger', 'fw-bold');
            break;
    }
    updateAttendanceCount();
}

function updateAttendanceCount() {
    const counts = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
    
    document.querySelectorAll('.attendance-select').forEach(select => {
        counts[select.value]++;
    });
    
    document.getElementById('hadirCount').textContent = counts.hadir;
    document.getElementById('sakitCount').textContent = counts.sakit;
    document.getElementById('izinCount').textContent = counts.izin;
    document.getElementById('alphaCount').textContent = counts.alpha;
}

// Initialize attendance count
document.addEventListener('DOMContentLoaded', function() {
    updateAttendanceCount();
    
    // Add event listeners to all attendance selects
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.addEventListener('change', function() {
            updateAttendanceColor(this);
        });
    });
});

// Confirm submit with SweetAlert2
function confirmSubmit() {
    const tanggal = document.getElementById('tanggal').value;
    const materi = document.getElementById('materi_kegiatan').value;
    const hadirCount = document.getElementById('hadirCount').textContent;
    const totalSiswa = {{ siswa_list|length }};
    
    if (!tanggal || !materi.trim()) {
        Swal.fire({
            icon: 'error',
            title: 'Form Belum Lengkap',
            text: 'Tanggal dan materi kegiatan harus diisi!'
        });
        return;
    }
    
    Swal.fire({
        title: 'Konfirmasi Simpan Pertemuan',
        html: `
            <div class="text-start">
                <p><strong>Tanggal:</strong> ${tanggal}</p>
                <p><strong>Kehadiran:</strong> ${hadirCount}/${totalSiswa} siswa</p>
                <hr>
                <p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i><strong>Perhatian:</strong> Data tidak dapat diubah setelah disimpan!</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Simpan!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('pertemuanForm').submit();
        }
    });
}
</script>
{% endblock %}