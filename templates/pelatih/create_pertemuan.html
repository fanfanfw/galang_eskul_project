{% extends 'base.html' %}

{% block title %}Buat Pertemuan - {{ eskul.nama_eskul }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-green-700 flex items-center">
            <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Buat Pertemuan Baru
        </h1>
        <a href="{% url 'pelatih_history_pertemuan' %}"
           class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Riwayat
        </a>
    </div>

    <!-- Eskul Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-blue-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
            </div>
            <div class="ml-4 flex-1">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-lg font-semibold text-blue-900 mb-2">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                {{ eskul.nama_eskul }}
                            </span>
                        </h2>
                        <p class="text-blue-700">
                            <span class="flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                {{ siswa_list|length }} siswa terdaftar
                            </span>
                        </p>
                    </div>
                    <div class="flex justify-end items-center">
                        <span class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium">
                            {{ today|date:"l, d F Y" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-yellow-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-800">
                    <strong>Perhatian:</strong> Data pertemuan yang sudah disimpan tidak dapat diubah lagi.
                    Pastikan semua informasi sudah benar sebelum menyimpan.
                </p>
            </div>
        </div>
    </div>

  <!-- Main Form -->
    <form method="post" enctype="multipart/form-data" id="pertemuanForm" class="space-y-6">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column -->
            <div class="space-y-6">
                <!-- Basic Info Card -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Informasi Pertemuan
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Tanggal Pertemuan <span class="text-red-500">*</span>
                                </span>
                            </label>
                            <input type="date" id="tanggal" name="tanggal" value="{{ today|date:'Y-m-d' }}" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                        </div>

                        <div>
                            <label for="materi_kegiatan" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    Materi Kegiatan <span class="text-red-500">*</span>
                                </span>
                            </label>
                            <textarea id="materi_kegiatan" name="materi_kegiatan" rows="4" required
                                      placeholder="Contoh: Latihan gerakan tari Saman, belajar koordinasi gerakan tangan dan kepala..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 resize-none"></textarea>
                            <p class="mt-1 text-sm text-gray-500">Jelaskan kegiatan yang dilakukan pada pertemuan ini</p>
                        </div>
                    </div>
                </div>

                <!-- Photo Upload Card -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Dokumentasi Kegiatan
                            </h3>
                            <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium" id="photoCount">Belum ada foto</span>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <button type="button" onclick="triggerFileInput()"
                                        class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                                    <span class="flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Ambil/Upload Foto
                                    </span>
                                </button>
                                <input type="file" id="foto_kegiatan" class="hidden" accept="image/*" capture="camera">
                                <div class="text-center text-sm text-gray-600 mt-2">
                                    <p class="font-semibold text-red-600">Wajib upload 1 foto dokumentasi</p>
                                    <p>Klik tombol untuk foto dari kamera atau pilih dari galeri.</p>
                                    <p class="text-green-600 text-xs mt-1">‚úì Foto otomatis dikompres untuk menghemat data</p>
                                </div>
                            </div>

                            <!-- Photo Collection -->
                            <div id="photoCollection" class="hidden">
                                <div class="flex justify-between items-center mb-3">
                                    <p class="text-sm text-gray-600">Foto yang akan diupload:</p>
                                    <button type="button" onclick="clearAllPhotos()"
                                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Hapus Semua
                                        </span>
                                    </button>
                                </div>
                                <div id="photoPreview" class="grid grid-cols-2 gap-2"></div>
                            </div>

                            <!-- Hidden inputs for photos -->
                            <div id="hiddenPhotoInputs"></div>
                        </div>
                    </div>
                </div>
            </div>
  
            <!-- Right Column - Attendance -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Absensi Siswa
                            </h3>
                            <span class="bg-gray-600 text-white px-3 py-1 rounded-full text-sm font-medium">{{ siswa_list|length }} siswa</span>
                        </div>
                    </div>
                    <div class="p-6">
                        {% if siswa_list %}
                            <div class="mb-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <button type="button" onclick="setAllAttendance('hadir')"
                                            class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200">
                                        <span class="flex items-center justify-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Semua Hadir
                                        </span>
                                    </button>
                                    <button type="button" onclick="resetAttendance()"
                                            class="bg-gray-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200">
                                        <span class="flex items-center justify-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                            Reset
                                        </span>
                                    </button>
                                </div>
                            </div>

                            <!-- Mobile-First Attendance Cards -->
                            <div class="lg:hidden">
                                <!-- Mobile View: Card Layout -->
                                <div id="mobileAttendance" class="space-y-2">
                                    {% for siswa in siswa_list %}
                                    <div class="bg-white border border-gray-200 rounded-lg p-3 attendance-card" data-student-id="{{ siswa.id }}">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center flex-1">
                                                <div class="attendance-status-indicator mr-3" id="indicator_{{ siswa.id }}">‚ùå</div>
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-900">{{ siswa.nama_siswa }}</p>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        {{ siswa.kelas }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div>
                                                <select name="absensi_{{ siswa.id }}" id="mobile_absensi_{{ siswa.id }}"
                                                        onchange="updateMobileAttendance(this, {{ siswa.id }})"
                                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm attendance-select attendance-mobile">
                                                    <option value="alpha">Alpha</option>
                                                    <option value="hadir">Hadir</option>
                                                    <option value="sakit">Sakit</option>
                                                    <option value="izin">Izin</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Desktop View: Table Layout -->
                            <div class="hidden lg:block">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for siswa in siswa_list %}
                                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">{{ siswa.nama_siswa }}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        {{ siswa.kelas }}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <select name="absensi_{{ siswa.id }}" id="desktop_absensi_{{ siswa.id }}"
                                                            onchange="updateDesktopAttendance(this, {{ siswa.id }})"
                                                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm attendance-select attendance-desktop">
                                                        <option value="alpha">‚ùå Alpha</option>
                                                        <option value="hadir">‚úÖ Hadir</option>
                                                        <option value="sakit">üè• Sakit</option>
                                                        <option value="izin">üìù Izin</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Attendance Summary -->
                            <div class="mt-6">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="bg-green-600 text-white rounded-lg p-3 text-center">
                                        <div class="text-2xl font-bold" id="hadirCount">0</div>
                                        <div class="text-sm">Hadir</div>
                                    </div>
                                    <div class="bg-yellow-500 text-gray-900 rounded-lg p-3 text-center">
                                        <div class="text-2xl font-bold" id="sakitCount">0</div>
                                        <div class="text-sm">Sakit</div>
                                    </div>
                                    <div class="bg-cyan-600 text-white rounded-lg p-3 text-center">
                                        <div class="text-2xl font-bold" id="izinCount">0</div>
                                        <div class="text-sm">Izin</div>
                                    </div>
                                    <div class="bg-red-600 text-white rounded-lg p-3 text-center">
                                        <div class="text-2xl font-bold" id="alphaCount">{{ siswa_list|length }}</div>
                                        <div class="text-sm">Alpha</div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293H6.586a1 1 0 01-.707-.293L3.464 9.293A1 1 0 012.757 9H5"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Siswa</h3>
                                <p class="text-gray-500">Tidak ada siswa terdaftar di eskul ini.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="p-8 text-center">
            <button type="button" onclick="confirmSubmit()"
                    class="bg-green-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path>
                    </svg>
                    Simpan Pertemuan
                </span>
            </button>
            <p class="text-gray-500 mt-3 text-sm">
                <span class="flex items-center justify-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Data tidak dapat diubah setelah disimpan
                                        </span>
            </p>
        </div>
    </div>
</form>

<script>
// Photo upload system - multiple photos one by one
let photoCollection = [];
let photoCounter = 0;

function triggerFileInput() {
    document.getElementById('foto_kegiatan').click();
}

document.getElementById('foto_kegiatan').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        // Check file size before processing (max 15MB original)
        const maxSize = 15 * 1024 * 1024; // 15MB
        if (file.size > maxSize) {
            alert('Ukuran foto terlalu besar! Maksimal 15MB per foto.\n\nUkuran foto Anda: ' + 
                  (file.size / 1024 / 1024).toFixed(1) + 'MB');
            return;
        }
        
        // Check if photo already exists
        if (photoCollection.length >= 1) {
            alert('Hanya 1 foto yang diperbolehkan per pertemuan!');
            return;
        }
        
        // Show loading indicator
        showPhotoLoading(true);
        
        // Compress image before adding to collection
        compressImage(file, function(compressedFile) {
            addPhotoToCollection(compressedFile, file.size);
            showPhotoLoading(false);
        }, function(error) {
            // Error callback
            showPhotoLoading(false);
            alert('Gagal memproses foto: ' + error);
        });
    } else if (file) {
        alert('File harus berupa gambar (JPG, PNG, etc.)');
    }
    // Reset input for next photo
    e.target.value = '';
});

// Image compression function
function compressImage(file, successCallback, errorCallback, quality = 0.8, maxWidth = 1200) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        try {
            // Calculate new dimensions
            let { width, height } = img;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            // Set canvas dimensions
            canvas.width = width;
            canvas.height = height;
            
            // Draw and compress
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(function(blob) {
                if (blob) {
                    // Create new file with compressed blob
                    const compressedFile = new File([blob], file.name, {
                        type: file.type,
                        lastModified: Date.now()
                    });
                    
                    successCallback(compressedFile);
                } else {
                    errorCallback('Gagal mengompres gambar');
                }
            }, file.type, quality);
        } catch (error) {
            errorCallback('Error saat memproses gambar: ' + error.message);
        }
    };
    
    img.onerror = function() {
        errorCallback('Gagal memuat gambar');
    };
    
    img.src = URL.createObjectURL(file);
}

function showPhotoLoading(show) {
    const button = document.querySelector('button[onclick="triggerFileInput()"]');
    if (show) {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Memproses foto...';
    } else {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-camera me-2"></i>Ambil/Upload Foto';
    }
}

function addPhotoToCollection(file, originalSize = null) {
    photoCounter++;
    const photoId = 'photo_' + photoCounter;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // Add to collection
        photoCollection.push({
            id: photoId,
            file: file,
            dataUrl: e.target.result,
            originalSize: originalSize
        });
        
        // Format file sizes
        const compressedSize = (file.size / 1024).toFixed(1) + ' KB';
        const originalSizeText = originalSize ? 
            ` (asli: ${(originalSize / 1024 / 1024).toFixed(1)} MB)` : '';
        
        // Create preview
        const preview = document.getElementById('photoPreview');
        const div = document.createElement('div');
        div.className = 'relative';
        div.id = 'preview_' + photoId;
        div.innerHTML = `
            <div>
                <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg shadow-sm"
                     style="object-fit: cover;">
                <button type="button" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700 transition-colors duration-200"
                        onclick="removePhoto('${photoId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <span class="absolute bottom-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">${photoCollection.length}</span>
                ${originalSize ? `<div class="absolute bottom-2 right-2">
                    <span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">${compressedSize}</span>
                </div>` : ''}
            </div>
            ${originalSize ? `<p class="text-xs text-gray-500 text-center mt-1">Dikompres: ${compressedSize}${originalSizeText}</p>` : ''}
        `;
        preview.appendChild(div);
        
        // Create hidden input for form submission
        const hiddenInputs = document.getElementById('hiddenPhotoInputs');
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'foto_kegiatan';
        input.style.display = 'none';
        input.id = 'input_' + photoId;
        
        // Create a new FileList with our file
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        
        hiddenInputs.appendChild(input);
        
        // Show collection and update count
        document.getElementById('photoCollection').style.display = 'block';
        updatePhotoCount();
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    // Remove from collection
    photoCollection = photoCollection.filter(photo => photo.id !== photoId);
    
    // Remove preview
    document.getElementById('preview_' + photoId).remove();
    
    // Remove hidden input
    document.getElementById('input_' + photoId).remove();
    
    // Update photo numbers
    updatePhotoNumbers();
    
    // Hide collection if empty
    if (photoCollection.length === 0) {
        document.getElementById('photoCollection').style.display = 'none';
    }
    
    updatePhotoCount();
}

function clearAllPhotos() {
    photoCollection = [];
    document.getElementById('photoPreview').innerHTML = '';
    document.getElementById('hiddenPhotoInputs').innerHTML = '';
    document.getElementById('photoCollection').style.display = 'none';
    updatePhotoCount();
}

function updatePhotoNumbers() {
    photoCollection.forEach((photo, index) => {
        const preview = document.getElementById('preview_' + photo.id);
        if (preview) {
            const badge = preview.querySelector('.badge');
            if (badge) badge.textContent = index + 1;
        }
    });
}

function updatePhotoCount() {
    const count = photoCollection.length;
    const totalSize = photoCollection.reduce((sum, photo) => sum + photo.file.size, 0);
    const totalSizeKB = (totalSize / 1024).toFixed(1);
    
    const photoCountBadge = document.getElementById('photoCount');
    const uploadButton = document.querySelector('button[onclick="triggerFileInput()"]');
    
    // Update count display
    if (count === 0) {
        photoCountBadge.textContent = 'Belum ada foto';
    } else {
        photoCountBadge.textContent = `1 foto (${totalSizeKB} KB)`;
    }
    
    // Update badge color based on count
    photoCountBadge.className = 'px-3 py-1 rounded-full text-sm font-medium ';
    if (count === 0) {
        photoCountBadge.classList.add('bg-blue-600', 'text-white');
    } else if (count === 1) {
        photoCountBadge.classList.add('bg-green-600', 'text-white');
    }

    // Disable/enable upload button when photo uploaded
    if (count >= 1) {
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<span class="flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Foto Telah Diupload</span>';
        uploadButton.classList.remove('bg-blue-600');
        uploadButton.classList.add('bg-green-600');
    } else {
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<span class="flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Ambil/Upload Foto</span>';
        uploadButton.classList.remove('bg-green-600');
        uploadButton.classList.add('bg-blue-600');
    }
}

// Attendance functions
function setAllAttendance(status) {
    // Set mobile selects (primary) and sync to desktop
    document.querySelectorAll('.attendance-mobile').forEach(select => {
        select.value = status;
        const studentId = select.name.replace('absensi_', '');
        
        // Update mobile
        updateAttendanceColor(select);
        updateMobileIndicator(studentId, status);
        
        // Sync with desktop
        const desktopSelect = document.getElementById('desktop_absensi_' + studentId);
        if (desktopSelect) {
            desktopSelect.value = status;
            updateAttendanceColor(desktopSelect);
        }
    });
    updateAttendanceCount();
}

function resetAttendance() {
    setAllAttendance('alpha');
}

function updateAttendanceColor(select) {
    // Preserve original classes
    const originalClasses = select.classList.contains('attendance-mobile') ?
        'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm attendance-select attendance-mobile' :
        'px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm attendance-select attendance-desktop';

    select.className = originalClasses;
    switch(select.value) {
        case 'hadir':
            select.classList.add('text-green-600', 'font-semibold');
            break;
        case 'sakit':
            select.classList.add('text-yellow-600', 'font-semibold');
            break;
        case 'izin':
            select.classList.add('text-cyan-600', 'font-semibold');
            break;
        case 'alpha':
            select.classList.add('text-red-600', 'font-semibold');
            break;
    }
    updateAttendanceCount();
}

// Mobile attendance functions
function updateMobileAttendance(select, studentId) {
    updateAttendanceColor(select);
    updateMobileIndicator(studentId, select.value);
    
    // Sync with desktop select
    const desktopSelect = document.getElementById('desktop_absensi_' + studentId);
    if (desktopSelect) {
        desktopSelect.value = select.value;
        updateAttendanceColor(desktopSelect);
    }
}

// Desktop attendance functions
function updateDesktopAttendance(select, studentId) {
    updateAttendanceColor(select);
    
    // Sync with mobile select
    const mobileSelect = document.getElementById('mobile_absensi_' + studentId);
    if (mobileSelect) {
        mobileSelect.value = select.value;
        updateMobileIndicator(studentId, select.value);
    }
}

function updateMobileIndicator(studentId, status) {
    const indicator = document.getElementById('indicator_' + studentId);
    if (indicator) {
        const statusMap = {
            'hadir': '‚úÖ',
            'sakit': 'üè•', 
            'izin': 'üìù',
            'alpha': '‚ùå'
        };
        indicator.textContent = statusMap[status] || '‚ùå';
        
        // Update card border color
        const card = indicator.closest('.attendance-card');
        if (card) {
            card.className = 'card mb-2 attendance-card';
            switch(status) {
                case 'hadir':
                    card.classList.add('border-success');
                    break;
                case 'sakit':
                    card.classList.add('border-warning');
                    break;
                case 'izin':
                    card.classList.add('border-info');
                    break;
                default:
                    card.classList.add('border-danger');
            }
        }
    }
}

function updateAttendanceCount() {
    const counts = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
    
    // Count from mobile selects only (they are the primary source)
    // Desktop selects are synced to mobile values
    document.querySelectorAll('.attendance-mobile').forEach(select => {
        counts[select.value]++;
    });
    
    document.getElementById('hadirCount').textContent = counts.hadir;
    document.getElementById('sakitCount').textContent = counts.sakit;
    document.getElementById('izinCount').textContent = counts.izin;
    document.getElementById('alphaCount').textContent = counts.alpha;
}

// Initialize attendance count
document.addEventListener('DOMContentLoaded', function() {
    // Initialize attendance count - should show correct initial values
    updateAttendanceCount();
    
    // Add event listeners to mobile selects
    document.querySelectorAll('.attendance-mobile').forEach(select => {
        select.addEventListener('change', function() {
            const studentId = this.name.replace('absensi_', '');
            updateMobileAttendance(this, studentId);
        });
    });
    
    // Add event listeners to desktop selects
    document.querySelectorAll('.attendance-desktop').forEach(select => {
        select.addEventListener('change', function() {
            const studentId = this.name.replace('absensi_', '');
            updateDesktopAttendance(this, studentId);
        });
    });
});

// Confirm submit with SweetAlert2
function confirmSubmit() {
    const tanggal = document.getElementById('tanggal').value;
    const materi = document.getElementById('materi_kegiatan').value;
    const hadirCount = document.getElementById('hadirCount').textContent;
    const totalSiswa = {{ siswa_list|length }};
    const photoCount = photoCollection.length;
    
    // Validation
    if (!tanggal || !materi.trim()) {
        Swal.fire({
            icon: 'error',
            title: 'Form Belum Lengkap',
            text: 'Tanggal dan materi kegiatan harus diisi!'
        });
        return;
    }
    
    if (photoCount === 0) {
        Swal.fire({
            icon: 'error',
            title: 'Foto Dokumentasi Wajib',
            text: '1 foto dokumentasi harus diupload untuk kegiatan!'
        });
        return;
    }
    
    Swal.fire({
        title: 'Konfirmasi Simpan Pertemuan',
        html: `
            <div class="text-start">
                <p><strong>Tanggal:</strong> ${tanggal}</p>
                <p><strong>Kehadiran:</strong> ${hadirCount}/${totalSiswa} siswa</p>
                <p><strong>Foto:</strong> ${photoCount} foto dokumentasi</p>
                <hr>
                <p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i><strong>Perhatian:</strong> Data tidak dapat diubah setelah disimpan!</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Simpan!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('pertemuanForm').submit();
        }
    });
}
</script>
{% endblock %}