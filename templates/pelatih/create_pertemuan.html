{% extends 'base.html' %}

{% block title %}Buat Pertemuan - {{ eskul.nama_eskul }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-success">
                <i class="bi bi-journal-plus me-2"></i>Buat Pertemuan Baru
            </h2>
            <a href="{% url 'pelatih_history_pertemuan' %}" class="btn btn-secondary">
                <i class="bi bi-clock-history me-2"></i>Riwayat
            </a>
        </div>
    </div>
</div>

<!-- Eskul Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">
                        <i class="bi bi-collection me-2"></i>{{ eskul.nama_eskul }}
                    </h5>
                    <p class="mb-0">
                        <i class="bi bi-people me-1"></i>{{ siswa_list|length }} siswa terdaftar
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-primary fs-6">{{ today|date:"l, d F Y" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Warning -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Perhatian:</strong> Data pertemuan yang sudah disimpan tidak dapat diubah lagi. 
            Pastikan semua informasi sudah benar sebelum menyimpan.
        </div>
    </div>
</div>

<!-- Main Form -->
<form method="post" enctype="multipart/form-data" id="pertemuanForm">
    {% csrf_token %}
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Basic Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Informasi Pertemuan
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="tanggal" class="form-label">
                            <i class="bi bi-calendar me-1"></i>Tanggal Pertemuan <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control form-control-lg" 
                               id="tanggal" name="tanggal" value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="materi_kegiatan" class="form-label">
                            <i class="bi bi-journal-text me-1"></i>Materi Kegiatan <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="materi_kegiatan" name="materi_kegiatan" 
                                rows="4" required 
                                placeholder="Contoh: Latihan gerakan tari Saman, belajar koordinasi gerakan tangan dan kepala..."></textarea>
                        <div class="form-text">Jelaskan kegiatan yang dilakukan pada pertemuan ini</div>
                    </div>
                </div>
            </div>

            <!-- Photo Upload Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-camera me-2"></i>Dokumentasi Kegiatan</span>
                    <span class="badge bg-primary" id="photoCount">0 Foto</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary btn-lg w-100 mb-2" onclick="triggerFileInput()">
                            <i class="bi bi-camera me-2"></i>Ambil/Upload Foto
                        </button>
                        <input type="file" class="d-none" id="foto_kegiatan" 
                               accept="image/*" capture="camera">
                        <div class="form-text text-center">
                            Klik tombol untuk foto dari kamera atau pilih dari galeri. Bisa dilakukan berulang kali.
                        </div>
                    </div>
                    
                    <!-- Photo Collection -->
                    <div id="photoCollection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Foto yang akan diupload:</small>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllPhotos()">
                                <i class="bi bi-trash me-1"></i>Hapus Semua
                            </button>
                        </div>
                        <div id="photoPreview" class="row g-2"></div>
                    </div>
                    
                    <!-- Hidden inputs for photos -->
                    <div id="hiddenPhotoInputs"></div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Attendance -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-person-check me-2"></i>Absensi Siswa</span>
                    <span class="badge bg-secondary">{{ siswa_list|length }} siswa</span>
                </div>
                <div class="card-body">
                    {% if siswa_list %}
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <button type="button" class="btn btn-success w-100" onclick="setAllAttendance('hadir')">
                                        <i class="bi bi-check-all me-1"></i>Semua Hadir
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-secondary w-100" onclick="resetAttendance()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile-First Attendance Cards -->
                        <div class="d-block d-lg-none">
                            <!-- Mobile View: Card Layout -->
                            <div id="mobileAttendance">
                                {% for siswa in siswa_list %}
                                <div class="card mb-2 attendance-card" data-student-id="{{ siswa.id }}">
                                    <div class="card-body p-2">
                                        <div class="row align-items-center">
                                            <div class="col-7">
                                                <div class="d-flex align-items-center">
                                                    <div class="attendance-status-indicator me-2" id="indicator_{{ siswa.id }}">‚ùå</div>
                                                    <div>
                                                        <div class="fw-bold small">{{ siswa.nama_siswa }}</div>
                                                        <span class="badge bg-info small">{{ siswa.kelas }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-5">
                                                <select class="form-select form-select-sm attendance-select" 
                                                        name="absensi_{{ siswa.id }}" onchange="updateMobileAttendance(this, {{ siswa.id }})">
                                                    <option value="alpha">Alpha</option>
                                                    <option value="hadir">Hadir</option>
                                                    <option value="sakit">Sakit</option>
                                                    <option value="izin">Izin</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Desktop View: Table Layout -->
                        <div class="d-none d-lg-block">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for siswa in siswa_list %}
                                        <tr>
                                            <td>
                                                <strong>{{ siswa.nama_siswa }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ siswa.kelas }}</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm attendance-select" 
                                                        name="absensi_{{ siswa.id }}" onchange="updateAttendanceColor(this)">
                                                    <option value="alpha">‚ùå Alpha</option>
                                                    <option value="hadir">‚úÖ Hadir</option>
                                                    <option value="sakit">üè• Sakit</option>
                                                    <option value="izin">üìù Izin</option>
                                                </select>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Attendance Summary -->
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="hadirCount">0</div>
                                            <small>Hadir</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="sakitCount">0</div>
                                            <small>Sakit</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="izinCount">0</div>
                                            <small>Izin</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body p-2">
                                            <div class="fs-4 fw-bold" id="alphaCount">{{ siswa_list|length }}</div>
                                            <small>Alpha</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted">Tidak ada siswa terdaftar di eskul ini.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-success btn-lg px-5" onclick="confirmSubmit()">
                        <i class="bi bi-save me-2"></i>Simpan Pertemuan
                    </button>
                    <p class="text-muted mt-2 mb-0">
                        <small><i class="bi bi-info-circle me-1"></i>Data tidak dapat diubah setelah disimpan</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Photo upload system - multiple photos one by one
let photoCollection = [];
let photoCounter = 0;

function triggerFileInput() {
    document.getElementById('foto_kegiatan').click();
}

document.getElementById('foto_kegiatan').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        addPhotoToCollection(file);
    }
    // Reset input for next photo
    e.target.value = '';
});

function addPhotoToCollection(file) {
    photoCounter++;
    const photoId = 'photo_' + photoCounter;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // Add to collection
        photoCollection.push({
            id: photoId,
            file: file,
            dataUrl: e.target.result
        });
        
        // Create preview
        const preview = document.getElementById('photoPreview');
        const div = document.createElement('div');
        div.className = 'col-6 col-md-4';
        div.id = 'preview_' + photoId;
        div.innerHTML = `
            <div class="position-relative">
                <img src="${e.target.result}" class="img-fluid rounded shadow-sm" 
                     style="height: 100px; object-fit: cover; width: 100%;">
                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                        onclick="removePhoto('${photoId}')" style="transform: translate(25%, -25%);">
                    <i class="bi bi-x"></i>
                </button>
                <span class="position-absolute bottom-0 start-0 badge bg-primary m-1">${photoCollection.length}</span>
            </div>
        `;
        preview.appendChild(div);
        
        // Create hidden input for form submission
        const hiddenInputs = document.getElementById('hiddenPhotoInputs');
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'foto_kegiatan';
        input.style.display = 'none';
        input.id = 'input_' + photoId;
        
        // Create a new FileList with our file
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        
        hiddenInputs.appendChild(input);
        
        // Show collection and update count
        document.getElementById('photoCollection').style.display = 'block';
        updatePhotoCount();
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    // Remove from collection
    photoCollection = photoCollection.filter(photo => photo.id !== photoId);
    
    // Remove preview
    document.getElementById('preview_' + photoId).remove();
    
    // Remove hidden input
    document.getElementById('input_' + photoId).remove();
    
    // Update photo numbers
    updatePhotoNumbers();
    
    // Hide collection if empty
    if (photoCollection.length === 0) {
        document.getElementById('photoCollection').style.display = 'none';
    }
    
    updatePhotoCount();
}

function clearAllPhotos() {
    photoCollection = [];
    document.getElementById('photoPreview').innerHTML = '';
    document.getElementById('hiddenPhotoInputs').innerHTML = '';
    document.getElementById('photoCollection').style.display = 'none';
    updatePhotoCount();
}

function updatePhotoNumbers() {
    photoCollection.forEach((photo, index) => {
        const preview = document.getElementById('preview_' + photo.id);
        if (preview) {
            const badge = preview.querySelector('.badge');
            if (badge) badge.textContent = index + 1;
        }
    });
}

function updatePhotoCount() {
    const count = photoCollection.length;
    document.getElementById('photoCount').textContent = count + (count === 1 ? ' Foto' : ' Foto');
}

// Attendance functions
function setAllAttendance(status) {
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.value = status;
        updateAttendanceColor(select);
        
        // Update mobile indicators if exists
        const studentId = select.name.replace('absensi_', '');
        updateMobileIndicator(studentId, status);
    });
    updateAttendanceCount();
}

function resetAttendance() {
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.value = 'alpha';
        updateAttendanceColor(select);
        
        // Update mobile indicators if exists  
        const studentId = select.name.replace('absensi_', '');
        updateMobileIndicator(studentId, 'alpha');
    });
    updateAttendanceCount();
}

function updateAttendanceColor(select) {
    select.className = 'form-select form-select-sm attendance-select';
    switch(select.value) {
        case 'hadir':
            select.classList.add('text-success', 'fw-bold');
            break;
        case 'sakit':
            select.classList.add('text-warning', 'fw-bold');
            break;
        case 'izin':
            select.classList.add('text-info', 'fw-bold');
            break;
        case 'alpha':
            select.classList.add('text-danger', 'fw-bold');
            break;
    }
    updateAttendanceCount();
}

// Mobile attendance functions
function updateMobileAttendance(select, studentId) {
    updateAttendanceColor(select);
    updateMobileIndicator(studentId, select.value);
}

function updateMobileIndicator(studentId, status) {
    const indicator = document.getElementById('indicator_' + studentId);
    if (indicator) {
        const statusMap = {
            'hadir': '‚úÖ',
            'sakit': 'üè•', 
            'izin': 'üìù',
            'alpha': '‚ùå'
        };
        indicator.textContent = statusMap[status] || '‚ùå';
        
        // Update card border color
        const card = indicator.closest('.attendance-card');
        if (card) {
            card.className = 'card mb-2 attendance-card';
            switch(status) {
                case 'hadir':
                    card.classList.add('border-success');
                    break;
                case 'sakit':
                    card.classList.add('border-warning');
                    break;
                case 'izin':
                    card.classList.add('border-info');
                    break;
                default:
                    card.classList.add('border-danger');
            }
        }
    }
}

function updateAttendanceCount() {
    const counts = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
    
    document.querySelectorAll('.attendance-select').forEach(select => {
        counts[select.value]++;
    });
    
    document.getElementById('hadirCount').textContent = counts.hadir;
    document.getElementById('sakitCount').textContent = counts.sakit;
    document.getElementById('izinCount').textContent = counts.izin;
    document.getElementById('alphaCount').textContent = counts.alpha;
}

// Initialize attendance count
document.addEventListener('DOMContentLoaded', function() {
    updateAttendanceCount();
    
    // Add event listeners to all attendance selects
    document.querySelectorAll('.attendance-select').forEach(select => {
        select.addEventListener('change', function() {
            updateAttendanceColor(this);
        });
    });
});

// Confirm submit with SweetAlert2
function confirmSubmit() {
    const tanggal = document.getElementById('tanggal').value;
    const materi = document.getElementById('materi_kegiatan').value;
    const hadirCount = document.getElementById('hadirCount').textContent;
    const totalSiswa = {{ siswa_list|length }};
    
    if (!tanggal || !materi.trim()) {
        Swal.fire({
            icon: 'error',
            title: 'Form Belum Lengkap',
            text: 'Tanggal dan materi kegiatan harus diisi!'
        });
        return;
    }
    
    Swal.fire({
        title: 'Konfirmasi Simpan Pertemuan',
        html: `
            <div class="text-start">
                <p><strong>Tanggal:</strong> ${tanggal}</p>
                <p><strong>Kehadiran:</strong> ${hadirCount}/${totalSiswa} siswa</p>
                <hr>
                <p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i><strong>Perhatian:</strong> Data tidak dapat diubah setelah disimpan!</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Simpan!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('pertemuanForm').submit();
        }
    });
}
</script>
{% endblock %}